<!DOCTYPE html>
<html>
<head>
	<title>TextLife</title>
	<script src='https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js'></script>
	<script src='https://apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js'></script>
	<link rel='stylesheet' href='https://apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.css'/>
	<link href="https://fonts.googleapis.com/css?family=Overpass+Mono" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<style type="text/css">
		body {
			font-family: 'Overpass Mono', monospace;
			font-size: 20px;
		}
		#question {
			padding-top: 5px;
		}
		#choices {
			margin: auto;
		}
		nav {
			font-family: 'Oswald', sans-serif;
		}
	</style>
</head>
<body>
	<nav class="navbar navbar-default">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="https://github.com/functionadvanced/TextLife">TextLife</a>
			</div>
			<button class="btn btn-default navbar-btn" onclick="Init()">Restart</button>
		</div>
	</nav>

	<div class="container">
		<p id="question"></p>
		<div id="choices-container">
			<div id="choices">
				<button class="btn btn-block choice" onclick="act(0)"></button>
				<button class="btn btn-block choice" onclick="act(1)"></button>
				<button class="btn btn-block choice" onclick="act(2)"></button>
				<button class="btn btn-block choice" onclick="act(3)"></button>
			</div>			
		</div>
		<br/>
		<div>
			<p>Diagram</p>
			<canvas id="myCanvas" width="4000" height="2000"></canvas>
		</div>
	</div>
	
</body>
<script type="text/javascript">
	var story_data;
	var now_uuid; // indicate which section of the story
	$.getJSON("story.json", function(data){
		story_data = data;
		Init();
		DrawTree(0.1, 0.1, "201701150005");
	});
	function JumpTo(_uuid) { // jump to a new section
		now_uuid = _uuid;
		$('#question').html(story_data[_uuid].question); // show the question
		for (i = 0;i < 4;++i)
			$('.choice').eq(i).css("display", "none");
		for (i = 0;i < story_data[_uuid].choices.length;++i) { // show choices
			$('.choice').eq(i).html(story_data[_uuid].choices[i]);
			$('.choice').eq(i).css("display", "block");
		}
		
	}
	function act(which) { // Act according to the choice
		JumpTo(story_data[now_uuid].destination[which]);
	}
	function Init() {// Initialize
		JumpTo("201701150005"); 
	}
	// draw relationship figure
	var canvas = document.getElementById("myCanvas");
	var ctx = canvas.getContext("2d");
	ctx.font = "15px sans-serif";
	var sx = 500; // diagram size
	var sy = 150;
	function DrawTree(_x, _y, _uuid) { // draw the diagram
		if (story_data[_uuid].flag) {
			ctx.fillStyle = "purple";
			ctx.fillText("****ENDING", _x*sx, _y*sy);
			return _y;
		}
		story_data[_uuid].flag = true;
		var len = story_data[_uuid].destination.length;
		ctx.fillStyle = "red";
		ctx.fillText("["+_uuid+"]", _x*sx, _y*sy);
		var slen = story_data[_uuid].question.length;
		var sindex = 0;
		ctx.fillStyle = 'blue';
		while(sindex < slen) {
			ctx.fillText(story_data[_uuid].question.substr(sindex, 30), _x*sx, _y*sy+sindex/30*20+20);
			sindex += 30;
		}
		ctx.beginPath();
		ctx.arc(_x*sx,_y*sy,2,0,2*Math.PI);
		ctx.stroke();
		var now_pos = _y;
		for (var i = 0;i < len;++i) {
			if (i > 0)
				now_pos++;
			ctx.moveTo(_x*sx, _y*sy);
			ctx.lineTo((_x+1)*sx, (now_pos)*sy);
			ctx.stroke();
			ctx.fillStyle = 'green';
			ctx.fillText(story_data[_uuid].choices[i], (_x+0.5)*sx, (_y+now_pos)*0.5*sy);
			now_pos=DrawTree(_x+1, now_pos, story_data[_uuid].destination[i]);
		}
		return now_pos;
	}	
</script>
</html>
